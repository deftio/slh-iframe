<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>XH Patient Explorer</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='4' fill='%231e1e1e'/><text x='16' y='23' font-family='Arial, sans-serif' font-size='18' font-weight='bold' text-anchor='middle' fill='%234CAF50'>XH</text></svg>">
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #121212;
      color: #ffffff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    header {
      padding: 1rem;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: left;
      background-color: #121212;
    }

    .iframe-container {
      flex: 1;
      position: relative;
      min-height: 0;
      margin : 2%;

    }

    iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;

    }

    .loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2rem;
      color: #888;
    }

    .error-msg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      display: none;
      background: #2a2a2a;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
    }

    .error-msg h3 {
      color: #ff6b6b;
      margin-top: 0;
    }

    .open-tab-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }

    .open-tab-btn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <header>
    XH Patient Explorer
  </header>
  <div class="iframe-container">
    <div class="loader" id="loader">Loading Second Look Health...</div>
    <div class="error-msg" id="errorMsg">
      <h3>Authentication Issue Detected</h3>
      <p>The application may have issues with third-party cookies or cross-origin authentication.</p>
      <p>This is common when embedding applications that require login.</p>
      <button class="open-tab-btn" onclick="openInNewTab()">Open in New Tab</button>
    </div>
    <iframe 
      id="appFrame"
      src="https://app.secondlookhealth.ai/v1/medical-cases?brand=new_brand_name"
      allow="camera; microphone; fullscreen; payment; clipboard-read; clipboard-write"
      allowfullscreen
      referrerpolicy="no-referrer-when-downgrade"
      sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-downloads allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
      onload="handleLoad()"
      onerror="handleError()">
    </iframe>
  </div>

  <script>
    let loadTimeout;
    let errorDetected = false;

    // Monitor for authentication issues
    window.addEventListener('message', function(e) {
      console.log('Message from iframe:', e.data);
      
      // Check for auth errors in messages
      if (e.data && (e.data.error === 'unauthorized' || e.data.status === 401)) {
        showAuthError();
      }
    });

    function handleLoad() {
      console.log('Iframe loaded successfully');
      clearTimeout(loadTimeout);
      document.getElementById('loader').style.display = 'none';
      
      // Try to detect if the iframe actually loaded content
      try {
        const iframe = document.getElementById('appFrame');
        // This will throw an error if cross-origin
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      } catch (e) {
        console.log('Cross-origin iframe detected - this is expected');
      }
    }

    function handleError() {
      console.error('Iframe loading error');
      showAuthError();
    }

    function showAuthError() {
      errorDetected = true;
      document.getElementById('loader').style.display = 'none';
      document.getElementById('errorMsg').style.display = 'block';
    }

    function openInNewTab() {
      window.open('https://app.secondlookhealth.ai/v1/medical-cases?brand=new_brand_name', '_blank');
    }

    // Set a timeout to detect if loading is taking too long
    loadTimeout = setTimeout(function() {
      if (!errorDetected) {
        console.log('Loading timeout - possible authentication issue');
        // Don't automatically show error, just log it
      }
    }, 10000);

    // Intercept console errors to detect 401s
    const originalError = console.error;
    console.error = function() {
      const args = Array.from(arguments);
      const errorStr = args.join(' ');
      if (errorStr.includes('401') || errorStr.includes('Unauthorized')) {
        showAuthError();
      }
      originalError.apply(console, arguments);
    };

    // Try to request storage access (for Safari and other browsers with strict cookie policies)
    document.addEventListener('DOMContentLoaded', function() {
      const iframe = document.getElementById('appFrame');
      
      // Check if Storage Access API is available
      if (document.hasStorageAccess && document.requestStorageAccess) {
        document.hasStorageAccess().then(hasAccess => {
          if (!hasAccess) {
            console.log('Requesting storage access for better cookie handling...');
            return document.requestStorageAccess();
          }
        }).then(() => {
          console.log('Storage access granted');
        }).catch(error => {
          console.log('Storage access denied:', error);
        });
      }
    });

    // Alternative: Open directly if URL parameter is set
    const params = new URLSearchParams(window.location.search);
    if (params.get('direct') === 'true') {
      openInNewTab();
    }
  </script>
</body>
</html>